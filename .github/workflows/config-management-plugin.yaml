name: Build and Release ArgoCD Configuration Management Plugin
on:
  push:
    tags:
      - "argo-cmp-v*"

jobs:
  container:
    name: ${{ matrix.job.kubectl_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        job:
          - { kubectl_version: v1.28.15 }
          - { kubectl_version: v1.29.13 }
          - { kubectl_version: v1.30.10 }
          - { kubectl_version: v1.31.6 }
          - { kubectl_version: v1.32.2 }
    steps:
      - name: Set env
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Login to Dockerhub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker Image
        uses: docker/build-push-action@v6.14.0
        with:
          context: transformers/envsubst
          file: transformers/envsubst/Dockerfile
          push: true 
          platforms: linux/amd64,linux/arm64,linux/aarch64
          tags: |
            docker.io/${{ github.repository_owner }}/argocd-cmp:${{env.RELEASE_VERSION}}-${{ matrix.job.kubectl_version }}
            ghcr.io/${{ github.repository_owner }}/argocd-cmp:${{env.RELEASE_VERSION}}-${{ matrix.job.kubectl_version }}
          labels: |
            maintainer=${{ github.repository_owner }} <github.com/${{ github.repository_owner }}>
            version=${{ matrix.job.kubectl_version }}
          build-args: |
            KUBECTL_VERSION=${{ matrix.job.kubectl_version }}
