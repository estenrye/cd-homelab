apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: cluster-aws-public-private
  labels:
    provider: aws
    cluster: eks
spec:
  compositeTypeRef:
    apiVersion: rye.ninja/v1alpha1
    kind: CompositeKubernetesCluster
  patchSets:
  - name: default-patchset
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.clusterName
      toFieldPath: metadata.labels.clusterName
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.clusterName
      toFieldPath: spec.forProvider.tags.Name
      transforms:
        - type: string
          string:
            fmt: "%s-crossplane-ekscluster"
            type: Format

  resources:
  - name: vpc
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: VPC
      spec:
        forProvider:
          enableDnsHostnames: true
          enableDnsSupport: true
          instanceTenancy: default
    readinessChecks:
      - type: MatchCondition
        matchCondition:
          status: 'True'
          type: Ready
    patches:
    - type: PatchSet
      patchSetName: default-patchset
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.clusterName
      toFieldPath: spec.forProvider.tags.Name
      transforms:
        - type: string
          string:
            fmt: "%s-crossplane-ekscluster"
            type: Format
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.vpc.cidrBlock
      toFieldPath: spec.forProvider.cidrBlock
  - name: publicSubnet-az-A
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Subnet
      metadata:
        labels: 
          subnet: public-a
      spec:
        forProvider:
          assignIpv6AddressOnCreation: false
          enableResourceNameDnsARecordOnLaunch: false
          enableResourceNameDnsAaaaRecordOnLaunch: false
          mapPublicIpOnLaunch: true
          tags:
            kubernetes.io/role/elb: "1"
          vpcIdSelector:
            matchControllerRef: true
    readinessChecks:
      - type: MatchCondition
        matchCondition:
          status: 'True'
          type: Ready
    patches:
    - type: PatchSet
      patchSetName: default-patchset
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.clusterName
      toFieldPath: spec.forProvider.tags.Name
      transforms:
        - type: string
          string:
            fmt: "%s-crossplane-ekscluster-public-subnet-a"
            type: Format
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.availabilityZone
      transforms:
        - type: string
          string:
            fmt: "%sa"
            type: Format
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.vpc.availabilityZone-a.publicCidrBlock
      toFieldPath: spec.forProvider.cidrBlock
  - name: publicSubnet-az-B
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Subnet
      metadata:
        labels: 
          subnet: public-b
      spec:
        forProvider:
          assignIpv6AddressOnCreation: false
          enableResourceNameDnsARecordOnLaunch: false
          enableResourceNameDnsAaaaRecordOnLaunch: false
          mapPublicIpOnLaunch: true
          tags:
            kubernetes.io/role/elb: "1"
          vpcIdSelector:
            matchControllerRef: true
    readinessChecks:
      - type: MatchCondition
        matchCondition:
          status: 'True'
          type: Ready
    patches:
    - type: PatchSet
      patchSetName: default-patchset
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.clusterName
      toFieldPath: spec.forProvider.tags.Name
      transforms:
        - type: string
          string:
            fmt: "%s-crossplane-ekscluster-public-subnet-b"
            type: Format
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.availabilityZone
      transforms:
        - type: string
          string:
            fmt: "%sb"
            type: Format
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.vpc.availabilityZone-b.publicCidrBlock
      toFieldPath: spec.forProvider.cidrBlock
  - name: publicSubnet-az-C
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Subnet
      metadata:
        labels: 
          subnet: public-c
      spec:
        forProvider:
          assignIpv6AddressOnCreation: false
          enableResourceNameDnsARecordOnLaunch: false
          enableResourceNameDnsAaaaRecordOnLaunch: false
          mapPublicIpOnLaunch: true
          tags:
            kubernetes.io/role/elb: "1"
          vpcIdSelector:
            matchControllerRef: true
    readinessChecks:
      - type: MatchCondition
        matchCondition:
          status: 'True'
          type: Ready
    patches:
    - type: PatchSet
      patchSetName: default-patchset
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.clusterName
      toFieldPath: spec.forProvider.tags.Name
      transforms:
        - type: string
          string:
            fmt: "%s-crossplane-ekscluster-public-subnet-c"
            type: Format
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.availabilityZone
      transforms:
        - type: string
          string:
            fmt: "%sc"
            type: Format
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.vpc.availabilityZone-b.publicCidrBlock
      toFieldPath: spec.forProvider.cidrBlock
  - name: internetGateway
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: InternetGateway
      spec:
        forProvider:
          vpcIdSelector:
            matchControllerRef: true
    readinessChecks:
      - type: MatchCondition
        matchCondition:
          status: 'True'
          type: Ready
    patches:
    - type: PatchSet
      patchSetName: default-patchset
  - name: publicRouteTable
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTable
      metadata:
        labels: 
          routetable: public
      spec:
        forProvider:
          tags:
            Name: team-a-public-subnet-a-rtb
            CrossplaneManaged: "true"
          vpcIdSelector:
            matchControllerRef: true
    readinessChecks:
      - type: MatchCondition
        matchCondition:
          status: 'True'
          type: Ready
    patches:
    - type: PatchSet
      patchSetName: default-patchset
  - name: publicRouteTableAssociation-az-A
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTableAssociation
      spec:
        forProvider:
          routeTableIdSelector:
            matchControllerRef: true
            matchLabels:
              routetable: public
          subnetIdSelector:
            matchControllerRef: true
            matchLabels:
              subnet: public-a
    readinessChecks:
      - type: MatchCondition
        matchCondition:
          status: 'True'
          type: Ready
    patches:
    - type: PatchSet
      patchSetName: default-patchset
  - name: publicRouteTableAssociation-az-B
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTableAssociation
      spec:
        forProvider:
          region: us-east-2
          routeTableIdSelector:
            matchControllerRef: true
            matchLabels:
              routetable: public
          subnetIdSelector:
            matchControllerRef: true
            matchLabels:
              subnet: public-b
    readinessChecks:
      - type: MatchCondition
        matchCondition:
          status: 'True'
          type: Ready
    patches:
    - type: PatchSet
      patchSetName: default-patchset
  - name: publicRouteTableAssociation-az-C
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTableAssociation
      spec:
        forProvider:
          routeTableIdSelector:
            matchControllerRef: true
            matchLabels:
              routetable: public
          subnetIdSelector:
            matchControllerRef: true
            matchLabels:
              subnet: public-c
    readinessChecks:
      - type: MatchCondition
        matchCondition:
          status: 'True'
          type: Ready
    patches:
    - type: PatchSet
      patchSetName: default-patchset
  - name: internetGatewayAttachment
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: InternetGatewayAttachment
      spec:
        forProvider:
          internetGatewayIdSelector:
            matchControllerRef: true
          vpcIdSelector:
            matchControllerRef: true
    readinessChecks:
      - type: MatchCondition
        matchCondition:
          status: 'True'
          type: Ready
    patches:
    - type: PatchSet
      patchSetName: default-patchset
  - name: publicRoute
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Route
      spec:
        forProvider:
          destinationCidrBlock: 0.0.0.0/0
          gatewayIdSelector:
            matchControllerRef: true
    readinessChecks:
      - type: MatchCondition
        matchCondition:
          status: 'True'
          type: Ready
    patches:
    - type: PatchSet
      patchSetName: default-patchset
