---
apiVersion: core.openfeature.dev/v1beta1
kind: FeatureFlag
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "flags.labels" . | nindent 4 }}
spec:
  flagSpec:
    flags:
    {{- range $flagKey, $flag := .Values.flags }}
      {{ $flagKey }}:
      {{- if not $flag }}
        state: ENABLED
        variants:
          "on": false
          "off": true
        defaultVariant: "off"
      {{- else }}
      {{- with $flag }}
        {{- $default := .default | default false }}
        {{- $enabled := .enabled | default true }}
        defaultVariant: {{ if $default }}"on"{{ else }}"off"{{ end }}
        state: {{ if $enabled }}"ENABLED"{{ else }}"DISABLED"{{ end }}
        variants:
          "on": true
          "off"                                                                                       : false
        {{- if .overrides}}
        targeting:
          if:
            - in:
              - var: id
              - {{ $flag.overrides | toJson }}
            - {{ if $default }}"off"{{ else }}"on"{{ end }}
            - {{ if $default }}"on"{{ else }}"off"{{ end }}
        {{- end }}
      {{- end }}
    {{- end }}
    {{- end }}
